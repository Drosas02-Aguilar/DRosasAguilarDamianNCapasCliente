<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Formulario</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    :root{ --grad-a:#0d6efd; --grad-b:#6610f2; --card-shadow:0 10px 28px rgba(0,0,0,.07); }
    body{ background:#f6f7fb }
    .hero{ background: radial-gradient(1000px 500px at top left, #ffffff10, transparent),
                   linear-gradient(90deg,var(--grad-a),var(--grad-b));
           color:#fff; border-radius:1.25rem; padding:1.75rem 1.5rem; margin:1rem 0 2rem;
           box-shadow:var(--card-shadow); }
    .card{ border:0; border-radius:1.25rem; box-shadow:var(--card-shadow) }
    .section-title{ display:flex; align-items:center; gap:.5rem; margin:0 0 1rem }
    .section-title .bi{ color:var(--grad-a) }
    .error-msg{ display:block; margin-top:.35rem; font-size:.85rem; color:#dc3545 }
    .avatar{ max-width:150px; max-height:150px; border-radius:10px; box-shadow:0 0 6px #ccc; object-fit:cover }
    .btn-gradient{ background:linear-gradient(90deg,var(--grad-a),var(--grad-b)); color:#fff; border:none }
    .btn-gradient:hover{ filter:brightness(.96); color:#fff }
    .action-bar{ position:sticky; bottom:0; background:#fff; z-index:1000; border-top:1px solid #eef0f3; backdrop-filter:blur(6px) }
 
      .error-msg{display:block;font-size:.85rem;margin-top:.25rem}
  .error-msg.text-success{color:#198754!important}
  .error-msg.text-danger{color:#dc3545!important}
  .is-valid{border-color:#198754!important}
  .is-invalid{border-color:#dc3545!important}
  
  </style>
</head>
<body>
<div class="container" th:with="
    did=${(#lists.isEmpty(Usuario?.direcciones)) ? 0 : Usuario.direcciones[0].idDireccion},
    esAlta=${Usuario.idUsuario == 0 and did == 0},
    esEditUsuario=${Usuario.idUsuario > 0 and did == -1},
    esAddDireccion=${Usuario.idUsuario > 0 and did == 0},
    esEditDireccion=${Usuario.idUsuario > 0 and did > 0}
">

  <!-- HERO -->
  <div class="hero">
    <h1 class="h4 mb-1"
        th:text="${
          esAlta ? 'Registro de Usuario' :
          (esEditUsuario ? 'Editar información de Usuario' :
          (esAddDireccion ? 'Agregar Dirección' : 'Editar Dirección'))
        }">Formulario</h1>
    <p class="mb-0 opacity-75"
       th:text="${
         esAlta ? 'Completa el formulario para agregar un nuevo usuario.' :
         (esEditUsuario ? 'Actualiza los datos del usuario.' :
         'Completa los datos de la dirección.')
       }">Descripción</p>
  </div>

  <form th:object="${Usuario}"
        method="post"
        th:action="@{/usuario/add}"
        id="formUsuario"
        enctype="multipart/form-data"
        novalidate>

    <!-- HIDDEN: idUsuario y did (idDireccion en direcciones[0]) -->
    <input type="hidden" th:field="*{idUsuario}"/>
    <input type="hidden" th:field="*{direcciones[0].idDireccion}"/>

    <!-- ===================== ALTA (usuario + dirección) ===================== -->
    <div th:if="${esAlta}">
      <!-- DATOS PERSONALES -->
      <div class="card p-4 mb-4">
        <h5 class="section-title"><i class="bi bi-person-lines-fill"></i><span>Datos personales</span></h5>
        <div class="row g-3">

          <!-- FOTO -->
          <div class="col-12">
            <label class="form-label fw-bold">Foto de usuario</label>
            <div class="d-flex align-items-center gap-3 flex-wrap">
              <img id="userFotoPreview" class="avatar" alt="Vista previa">
              <div class="flex-grow-1">
                <input type="file" id="userFotoInput" name="userFotoInput" class="form-control" accept="image/*">
                <small class="text-muted d-block mt-1">Formatos: JPG</small>
                <button type="button" id="btnQuitarUserFoto" class="btn btn-sm btn-outline-secondary mt-2">
                  Limpiar foto</button>
              </div>
            </div>
            <span class="error-msg" id="userFotoMsg"></span>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Nombre</label>
            <input class="form-control" th:field="*{nombre}" placeholder="Nombre" maxlength="50" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Apellido paterno</label>
            <input class="form-control" th:field="*{apellidopaterno}" placeholder="Apellido Paterno" maxlength="50" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Apellido materno</label>
            <input class="form-control" th:field="*{apellidomaterno}" placeholder="Apellido materno" maxlength="50">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Sexo</label>
            <select class="form-select" th:field="*{sexo}" required>
              <option value="0" disabled selected>Selecciona…</option>
              <option value="M">Masculino</option>
              <option value="F">Femenino</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">CURP</label>
            <input class="form-control text-uppercase"
                   th:field="*{curp}" placeholder="CURP" maxlength="18" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Fecha de nacimiento</label>
            <input class="form-control" type="date" th:field="*{fechaNacimiento}" required>
          </div>
        </div>
      </div>

      <!-- ACCESO Y CONTACTO -->
      <div class="card p-4 mb-4">
        <h5 class="section-title"><i class="bi bi-shield-lock"></i><span>Acceso y contacto</span></h5>
        <div class="row g-3">

          <div class="col-md-4">
            <label class="form-label fw-bold">Username</label>
            <input class="form-control" th:field="*{username}"
                   placeholder="Username" maxlength="30" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Email</label>
            <input class="form-control" type="email" th:field="*{email}"
                   placeholder="Email" maxlength="80" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Contraseña</label>
            <input class="form-control" type="password" th:field="*{password}"
                   placeholder="Contraseña" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Teléfono (10 dígitos)</label>
            <input class="form-control" th:field="*{telefono}"
                   placeholder="Teléfono" maxlength="10" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Celular (10 dígitos)</label>
            <input class="form-control" th:field="*{celular}"
                   placeholder="Celular" maxlength="10" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Tipo de sangre</label>
            <input class="form-control" th:field="*{tiposangre}"
                   placeholder="Ej. O+, A-" maxlength="5">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Rol</label>
            <select class="form-select" th:field="*{rol.idRol}">
              <option value="0" selected disabled>Selecciona un rol</option>
              <option th:each="Rol : ${roles}" th:text="${Rol.nombre}" th:value="${Rol.idRol}">Rol</option>
            </select>
          </div>
        </div>
      </div>

      <!-- DIRECCIÓN -->
      <div class="card p-4 mb-5">
        <h5 class="section-title"><i class="bi bi-geo-alt"></i><span>Dirección</span></h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label fw-bold">Calle</label>
            <input class="form-control"
                   th:field="*{direcciones[0].calle}" placeholder="Calle" maxlength="80" required>
          </div>

          <div class="col-md-3">
            <label class="form-label fw-bold">Número exterior</label>
            <input class="form-control"
                   th:field="*{direcciones[0].numeroExterior}" placeholder="Número exterior" maxlength="10">
          </div>

          <div class="col-md-3">
            <label class="form-label fw-bold">Número interior</label>
            <input class="form-control"
                   th:field="*{direcciones[0].numeroInterior}" placeholder="Número interior" maxlength="10">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">País</label>
            <select id="paisddl" class="form-select"
                    th:field="*{direcciones[0].colonia.municipio.estado.pais.idPais}">
              <option value="0" selected disabled>-- Selecciona un país --</option>
              <option th:each="pais : ${paises}"
                      th:value="${pais.idPais}" th:text="${pais.nombre}"></option>
            </select>
          </div>

          <div class="col-md-3">
            <label for="estadoddl" class="form-label fw-bold">Estado</label>
            <select id="estadoddl" class="form-select"
                    th:field="*{direcciones[0].colonia.municipio.estado.idEstado}">
              <option value="0" selected>Selecciona un estado</option>
            </select>
          </div>

          <div class="col-md-3">
            <label for="municipioddl" class="form-label fw-bold">Municipio</label>
            <select id="municipioddl" class="form-select"
                    th:field="*{direcciones[0].colonia.municipio.idMunicipio}">
              <option value="0" selected>Selecciona un municipio</option>
            </select>
          </div>

          <div class="col-md-3">
            <label for="coloniaddl" class="form-label fw-bold">Colonia</label>
            <select id="coloniaddl" class="form-select"
                    th:field="*{direcciones[0].colonia.idColonia}">
              <option value="0" selected>Selecciona una colonia</option>
            </select>
          </div>

          <div class="col-md-3">
            <label for="CodigoPostal" class="form-label fw-bold">Código Postal</label>
            <input id="CodigoPostal" type="text" class="form-control"
                   placeholder="Código Postal"
                   th:field="*{direcciones[0].colonia.codigoPostal}"
                   readonly>
          </div>
        </div>
      </div>
    </div>

    <!-- ===================== EDITAR USUARIO ===================== -->
    <div th:if="${esEditUsuario}">
      <div class="card p-4 mb-4">
        <h5 class="section-title"><i class="bi bi-person-lines-fill"></i><span>Datos personales</span></h5>
        <div class="row g-3">

          <!-- FOTO -->
          <div class="col-12">
            <label class="form-label fw-bold">Foto de usuario</label>
            <div class="d-flex align-items-center gap-3 flex-wrap">
              <img id="userFotoPreview" class="avatar" alt="Vista previa">
              <div class="flex-grow-1">
                <input type="file" id="userFotoInput" name="userFotoInput" class="form-control" accept="image/*">
                <small class="text-muted d-block mt-1">Formatos: JPG, PNG, JPEG</small>
                <button type="button" id="btnQuitarUserFoto" class="btn btn-sm btn-outline-secondary mt-2">
                  Limpiar foto</button>
              </div>
            </div>
            <span class="error-msg" id="userFotoMsg"></span>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Nombre</label>
            <input class="form-control" th:field="*{nombre}" placeholder="Nombre" maxlength="50" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Apellido paterno</label>
            <input class="form-control" th:field="*{apellidopaterno}" placeholder="Apellido Paterno" maxlength="50" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Apellido materno</label>
            <input class="form-control" th:field="*{apellidomaterno}" placeholder="Apellido materno" maxlength="50">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Sexo</label>
            <select class="form-select" th:field="*{sexo}" required>
              <option value="0" disabled>Selecciona…</option>
              <option value="M">Masculino</option>
              <option value="F">Femenino</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">CURP</label>
            <input class="form-control text-uppercase"
                   th:field="*{curp}" placeholder="CURP" maxlength="18" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Fecha de nacimiento</label>
            <input class="form-control" type="date" th:field="*{fechaNacimiento}" required>
          </div>
        </div>
      </div>

      <div class="card p-4 mb-4">
        <h5 class="section-title"><i class="bi bi-shield-lock"></i><span>Acceso y contacto</span></h5>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label fw-bold">Username</label>
            <input class="form-control" th:field="*{username}"
                   placeholder="Username" maxlength="30" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Email</label>
            <input class="form-control" type="email" th:field="*{email}"
                   placeholder="Email" maxlength="80" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Contraseña</label>
            <input class="form-control" type="password" th:field="*{password}"
                   placeholder="Contraseña" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Teléfono</label>
            <input class="form-control" th:field="*{telefono}"
                   placeholder="Teléfono" maxlength="10" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Celular</label>
            <input class="form-control" th:field="*{celular}"
                   placeholder="Celular" maxlength="10" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Tipo de sangre</label>
            <input class="form-control" th:field="*{tiposangre}"
                   placeholder="Ej. O+, A-" maxlength="5">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Rol</label>
            <select class="form-select" th:field="*{rol.idRol}">
              <option value="0" disabled>Selecciona un rol</option>
              <option th:each="Rol : ${roles}" th:text="${Rol.nombre}" th:value="${Rol.idRol}">Rol</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- ===================== AGREGAR/EDITAR DIRECCIÓN ===================== -->
    <div th:if="${esAddDireccion or esEditDireccion}">
      <div class="card p-4 mb-5">
        <h5 class="section-title"><i class="bi bi-geo-alt"></i>
          <span th:text="${esAddDireccion ? 'Nueva dirección' : 'Editar dirección'}">Dirección</span>
        </h5>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label fw-bold">Calle</label>
            <input class="form-control"
                   th:field="*{direcciones[0].calle}" placeholder="Calle" maxlength="80" required>
          </div>

          <div class="col-md-3">
            <label class="form-label fw-bold">Número exterior</label>
            <input class="form-control"
                   th:field="*{direcciones[0].numeroExterior}" placeholder="Número exterior" maxlength="10">
          </div>

          <div class="col-md-3">
            <label class="form-label fw-bold">Número interior</label>
            <input class="form-control"
                   th:field="*{direcciones[0].numeroInterior}" placeholder="Número interior" maxlength="10">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">País</label>
            <select id="paisddl" class="form-select" th:field="*{direcciones[0].colonia.municipio.estado.pais.idPais}">
              <option value="0" selected disabled>-- Selecciona un país --</option>
              <option th:each="Pais : ${paises}"
                      th:value="${Pais.idPais}"
                      th:text="${Pais.nombre}">
              </option>
            </select>
          </div>

          <div class="col-md-3">
            <label for="estadoddl" class="form-label fw-bold">Estado</label>
            <select id="estadoddl" class="form-select" th:field="*{direcciones[0].colonia.municipio.estado.idEstado}">
              <option value="0" selected>Selecciona un estado</option>
            </select>
          </div>

          <div class="col-md-3">
            <label for="municipioddl" class="form-label fw-bold">Municipio</label>
            <select id="municipioddl" class="form-select" th:field="*{direcciones[0].colonia.municipio.idMunicipio}">
              <option value="0" selected>Selecciona un municipio</option>
            </select>
          </div>

          <div class="col-md-3">
            <label for="coloniaddl" class="form-label fw-bold">Colonia</label>
            <select id="coloniaddl" class="form-select" th:field="*{direcciones[0].colonia.idColonia}">
              <option value="0" selected>Selecciona una colonia</option>
            </select>
          </div>

          <div class="col-md-3">
            <label for="CodigoPostal" class="form-label fw-bold">Código Postal</label>
            <input id="CodigoPostal" type="text" class="form-control"
                   placeholder="Código Postal"
                   th:field="*{direcciones[0].colonia.codigoPostal}"
                   readonly>
          </div>
        </div>
      </div>
    </div>

    <!-- Acciones -->
    <div class="action-bar py-3">
      <div class="container d-flex justify-content-center gap-2">
        <button type="submit" class="btn btn-gradient btn-lg">
          <i class="bi bi-check2-circle me-1"></i>
          <span>Guardar</span>
        </button>
        <a th:href="${Usuario.idUsuario > 0} ? @{/usuario/action/{id}(id=${Usuario.idUsuario})} : @{/usuario}" class="btn btn-outline-secondary btn-lg">
          <i class="bi bi-arrow-left me-1"></i> Cancelar
        </a>
      </div>
    </div>
  </form>
</div>

<!-- ===================== SCRIPTS ===================== -->
<script>
/* =================== Helpers =================== */
function ensureMsgSpan(el){
  // Intenta encontrar un <span.error-msg> cercano; si no existe, lo crea.
  let container = el.closest('.col-md-4, .col-md-3, .col-md-6, .col-md-12, .col, .form-group, .form-floating') || el.parentElement;
  let span = container.querySelector('.error-msg');
  if(!span){
    span = document.createElement('span');
    span.className = 'error-msg';
    // Si es form-floating, ponlo después del label; si no, después del input
    if(container.classList && container.classList.contains('form-floating')){
      const label = container.querySelector('label');
      if (label && label.nextSibling) {
        label.parentNode.insertBefore(span, label.nextSibling);
      } else {
        container.appendChild(span);
      }
    } else {
      if (el.nextSibling) el.parentNode.insertBefore(span, el.nextSibling);
      else el.parentNode.appendChild(span);
    }
  }
  return span;
}
function setValid(el, msg="✓"){
  el.classList.remove('is-invalid','error');
  el.classList.add('is-valid','correct');
  const s = ensureMsgSpan(el);
  s.textContent = msg;
  s.classList.remove('text-danger');
  s.classList.add('text-success');
}
function setInvalid(el, msg){
  el.classList.remove('is-valid','correct');
  el.classList.add('is-invalid','error');
  const s = ensureMsgSpan(el);
  s.textContent = msg || 'Campo inválido';
  s.classList.remove('text-success');
  s.classList.add('text-danger');
}

/* =================== Validadores =================== */
function NombreVal(el){
  const v=(el.value||'').trim();
  if(v.length<2) return setInvalid(el,'Mínimo 2 caracteres.');
  if(!/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s'.-]{2,50}$/.test(v)) return setInvalid(el,"Solo letras y . ' -");
  setValid(el,'✓ Nombre válido');
}
function NombreOpcVal(el){
  const v=(el.value||'').trim();
  if(v==='') return setValid(el,'(Opcional)');
  return NombreVal(el);
}
function SexoVal(el){
  const v=el.value;
  if(v==='M'||v==='F') return setValid(el,'✓ Seleccionado');
  setInvalid(el,'Selecciona M o F.');
}
function CurpVal(el,estricto){
  let v=(el.value||'').toUpperCase(); el.value=v;
  const re=/^[A-Z]{1}[AEIOUX]{1}[A-Z]{2}\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])[HM](AS|BC|BS|CC|CL|CM|CS|CH|DF|DG|GT|GR|HG|JC|MC|MN|MS|NT|NL|OC|PL|QT|QR|SP|SL|SR|TC|TS|TL|VZ|YN|ZS|NE)[B-DF-HJ-NP-TV-Z]{3}[0-9A-Z]\d$/;
  if(v.length===0 && !estricto) return setInvalid(el,'Requerido.');
  if(!re.test(v)) return setInvalid(el,'CURP inválida.');
  setValid(el,'✓ CURP válida');
}
function FechaVal(el){
  const v=el.value;
  if(!v) return setInvalid(el,'Requerido.');
  const f=new Date(v); const hoy=new Date();
  if(f>hoy) return setInvalid(el,'No puede ser futura.');
  const age=hoy.getFullYear()-f.getFullYear()-((hoy.getMonth()<f.getMonth()||(hoy.getMonth()==f.getMonth()&&hoy.getDate()<f.getDate()))?1:0);
  if(age<16) return setInvalid(el,'Mínimo 16 años.');
  if(age>120) return setInvalid(el,'Revisa la fecha.');
  setValid(el,'✓ Fecha válida');
}
function UsernameVal(el){
  const v=(el.value||'').trim();
  if(v.length<3) return setInvalid(el,'Mínimo 3 caracteres.');
  if(/^\d/.test(v)) return setInvalid(el,'No debe iniciar con número.');
  if(!/^[A-Za-z0-9._-]{3,30}$/.test(v)) return setInvalid(el,'Solo letras, números, . _ -');
  setValid(el,'✓ Username válido');
}
function EmailVal(el){
  const email=(el.value||'').trim();
  const re=/^(?!.*\.\.)[a-zA-Z0-9](\.?[a-zA-Z0-9_-])*@[a-zA-Z0-9-]+(\.[a-zA-Z]{2,})+$/;
  if(!re.test(email)) return setInvalid(el,'Email inválido.');
  setValid(el,'✓ Email válido');
}
function PassVal(el){
  const v=el.value||'';
  if(v.length<8) return setInvalid(el,'Mínimo 8 caracteres.');
  if(!/[A-Z]/.test(v)||!/[a-z]/.test(v)||!/\d/.test(v)||!/[^\w\s]/.test(v))
    return setInvalid(el,'Incluye mayúscula, minúscula, número y símbolo.');
  setValid(el,'✓ Contraseña segura');
}
function TelVal(el){
  // Limpia no dígitos en vivo
  el.value = (el.value||'').replace(/\D+/g,'');
  const v=el.value;
  if(!/^\d{10}$/.test(v)) return setInvalid(el,'Debe tener 10 dígitos.');
  setValid(el,'✓ Número válido');
}
function SangreVal(el){
  const v=(el.value||'').toUpperCase();
  if(v==='') return setValid(el,'(Opcional)');
  if(!/^(A|B|AB|O)[+-]$/.test(v)) return setInvalid(el,'Formato ej. O+, A-');
  el.value=v; setValid(el,'✓ Formato válido');
}
function CalleVal(el){
  const v=(el.value||'').trim();
  if(v.length<3) return setInvalid(el,'Mínimo 3 caracteres.');
  if(v.length>80) return setInvalid(el,'Máximo 80 caracteres.');
  setValid(el,'✓');
}
function PuertaVal(el){
  const v=(el.value||'').trim();
  if(v==='') return setValid(el,'(Opcional)');
  if(!/^[A-Za-z0-9\-\/]{1,10}$/.test(v)) return setInvalid(el,'Máx 10, solo A-Z,0-9,-,/');
  setValid(el,'✓');
}
function IdPosVal(el){
  const v=el.value;
  if(!v||v==='0') return setInvalid(el,'Selecciona una opción.');
  setValid(el,'✓ Seleccionado');
}

/* ============ Mapa: selector -> validador ============ */
/* Usamos los NAME reales que genera th:field */
const validators = [
  { sel: '[name="nombre"]',                    fn: NombreVal },
  { sel: '[name="apellidopaterno"]',           fn: NombreVal },
  { sel: '[name="apellidomaterno"]',           fn: NombreOpcVal },
  { sel: '[name="sexo"]',                      fn: SexoVal },
  { sel: '[name="curp"]',                      fn: (el)=>CurpVal(el,true) },
  { sel: '[name="fechaNacimiento"]',           fn: FechaVal },

  { sel: '[name="username"]',                  fn: UsernameVal },
  { sel: '[name="email"]',                     fn: EmailVal },
  { sel: '[name="password"]',                  fn: PassVal },
  { sel: '[name="telefono"]',                  fn: TelVal },
  { sel: '[name="celular"]',                   fn: TelVal },
  { sel: '[name="tiposangre"]',                fn: SangreVal },
  { sel: '[name="rol.idRol"]',                 fn: IdPosVal },

  // Dirección (si existe en la vista)
  { sel: '[name="direcciones[0].calle"]',                     fn: CalleVal },
  { sel: '[name="direcciones[0].numeroExterior"]',            fn: PuertaVal },
  { sel: '[name="direcciones[0].numeroInterior"]',            fn: PuertaVal },
  { sel: '[name="direcciones[0].colonia.municipio.estado.pais.idPais"]', fn: IdPosVal },
  { sel: '[name="direcciones[0].colonia.municipio.estado.idEstado"]',    fn: IdPosVal },
  { sel: '[name="direcciones[0].colonia.municipio.idMunicipio"]',        fn: IdPosVal },
  { sel: '[name="direcciones[0].colonia.idColonia"]',                     fn: IdPosVal }
];

/* ============ Listeners en vivo ============ */
function attachLiveValidation(){
  // Delegado: solo dentro del form principal
  document.addEventListener('input', (e)=>{
    const form = e.target.closest('#formUsuario');
    if(!form) return;
    const v = validators.find(x => e.target.matches(x.sel));
    if(v) v.fn(e.target);
  });
  document.addEventListener('change', (e)=>{
    const form = e.target.closest('#formUsuario');
    if(!form) return;
    const v = validators.find(x => e.target.matches(x.sel));
    if(v) v.fn(e.target);
  });
}
attachLiveValidation();

/* ============ Validar todo al enviar ============ */
function validateAllIn(form){
  validators.forEach(v=>{
    form.querySelectorAll(v.sel).forEach(el=>v.fn(el));
  });
}
document.addEventListener('submit', function(e){
  const form = e.target;
  if(form.id !== 'formUsuario') return;
  validateAllIn(form);
  const invalid = form.querySelector('.is-invalid, .error');
  if(invalid){
    e.preventDefault();
    invalid.focus({preventScroll:false});
    alert('Revisa los campos marcados en rojo.');
  }
}, true);

/* ============ Imagen: preview y limpieza ============ */
document.addEventListener('DOMContentLoaded', () => {
  const input   = document.getElementById('userFotoInput');
  const preview = document.getElementById('userFotoPreview');
  const hidden  = document.getElementById('userFotoBase64'); // si no existe, no pasa nada
  const msg     = document.getElementById('userFotoMsg');
  const btnQ    = document.getElementById('btnQuitarUserFoto');
  if (!input || !preview) return;

  const DEFAULT_AVATAR =
    "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><rect width='128' height='128' fill='%23e9ecef'/><circle cx='64' cy='48' r='24' fill='%23adb5bd'/><path d='M24 112c0-22 18-32 40-32s40 10 40 32' fill='%23adb5bd'/></svg>";

  const currentSrc = preview.getAttribute('src');
  if (!currentSrc || currentSrc.trim()==="") { preview.src=DEFAULT_AVATAR; preview.style.display='block'; }

  const resetInput = () => {
    input.value = "";
    preview.src=DEFAULT_AVATAR; preview.style.display='block';
    if (hidden) hidden.value = "";
    if (msg) msg.textContent = "";
  };
  if (btnQ) btnQ.addEventListener('click',(e)=>{ e.preventDefault(); resetInput(); });

  input.addEventListener('change',(e)=>{
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    const allowed=['image/jpeg','image/png','image/webp'];
    if (!allowed.includes(f.type)){ if(msg) msg.textContent='Formato no válido. Usa JPG, PNG o WebP.'; resetInput(); return; }
    if (f.size > 2*1024*1024){ if(msg) msg.textContent='La imagen excede 2 MB.'; resetInput(); return; }
    const reader=new FileReader();
    reader.onload=(ev)=>{
      const dataUrl=ev.target.result;
      preview.src=dataUrl; preview.style.display='block';
      if(hidden) hidden.value=dataUrl;
      if(msg) msg.textContent="";
    };
    reader.readAsDataURL(f);
  });
});

/* ============ Cascada País/Estado/Municipio/Colonia ============ */
$(document).ready(function(){
  if (!$('#paisddl').length) return;

  $("#paisddl").change(function(){
    const idPais = $(this).val();
    if (!idPais || idPais === "0") return;

    $.ajax({
      type: "GET",
      url: `http://localhost:8080/catalogoapi/estados/${idPais}`,
      dataType: "json",
      success: function(data){
        if (data && data.correct) {
          const estados = data.object || [];
          $("#estadoddl").empty().append("<option value='0' selected>Selecciona un estado</option>");
          estados.forEach(e => $("#estadoddl").append(`<option value='${e.idEstado}'>${e.nombre}</option>`));
          $("#municipioddl").empty().append("<option value='0' selected>Selecciona un municipio</option>");
          $("#coloniaddl").empty().append("<option value='0' selected>Selecciona una colonia</option>");
          $("#CodigoPostal").val("");
        } else { alert("No se encontraron estados para el país seleccionado."); }
      },
      error: function(){ alert("Ocurrió un error al cargar los estados."); }
    });
  });

  $("#estadoddl").change(function(){
    const idEstado = $(this).val();
    if (!idEstado || idEstado === "0") return;

    $.ajax({
      type: "GET",
      url: `http://localhost:8080/catalogoapi/municipios/${idEstado}`,
      dataType: "json",
      success: function(data){
        if (data && data.correct) {
          const municipios = data.object || [];
          $("#municipioddl").empty().append("<option value='0' selected>Selecciona un municipio</option>");
          municipios.forEach(m => $("#municipioddl").append(`<option value='${m.idMunicipio}'>${m.nombre}</option>`));
          $("#coloniaddl").empty().append("<option value='0' selected>Selecciona una colonia</option>");
          $("#CodigoPostal").val("");
        } else { alert("No se encontraron municipios para el estado seleccionado."); }
      },
      error: function(){ alert("Ocurrió un error al cargar los municipios."); }
    });
  });

  $("#municipioddl").change(function(){
    const idMunicipio = $(this).val();
    $("#CodigoPostal").val("");

    if (!idMunicipio || idMunicipio === "0") {
      $("#coloniaddl").empty().append("<option value='0' selected>Selecciona una colonia</option>");
      return;
    }

    $.ajax({
      type: "GET",
      url: `http://localhost:8080/catalogoapi/colonias/${idMunicipio}`,
      dataType: "json",
      success: function(data){
        if (data && data.correct) {
          const colonias = data.object || [];
          $("#coloniaddl").empty().append("<option value='0' selected>Selecciona una colonia</option>");
          colonias.forEach(c => {
            $("#coloniaddl").append(
              `<option value='${c.idColonia}' data-cp='${c.codigoPostal || ""}'>${c.nombre}</option>`
            );
          });
          $("#coloniaddl").off("change.coloniaCP").on("change.coloniaCP", function(){
            const cp = $(this).find(":selected").data("cp") || "";
            $("#CodigoPostal").val(cp);
          });
        } else {
          $("#coloniaddl").empty().append("<option value='0' selected>Selecciona una colonia</option>");
        }
      },
      error: function(){
        alert("Ocurrió un error al cargar las colonias.");
        $("#coloniaddl").empty().append("<option value='0' selected>Selecciona una colonia</option>");
      }
    });
  });
});

/* ============ Bloquear copiar/pegar en campos sensibles ============ */
document.addEventListener('DOMContentLoaded', ()=>{
  // Lista de selectores de campos donde no se permite copiar/pegar
  const bloqueados = [
    '[name="username"]',
    '[name="curp"]',
    '[name="telefono"]',
    '[name="celular"]',
    '[name="password"]'
  ];

  bloqueados.forEach(sel=>{
    document.querySelectorAll(sel).forEach(el=>{
      ['paste','copy','cut'].forEach(ev=>{
        el.addEventListener(ev, e=>{
          e.preventDefault();
          alert('❌ No se permite ' + ev + ' en este campo');
        });
      });
      // Opcional: bloquear arrastrar y soltar
      el.addEventListener('drop', e=>e.preventDefault());
    });
  });
});

</script>




<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
